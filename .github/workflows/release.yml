name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary_name: clashtui
            build_tool: cargo
            package_linux: true
            package_pkg: false
            brew_archive: true
            deb_no_strip: false
            deb_variant: ""
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            binary_name: clashtui
            build_tool: cross
            package_linux: false
            package_pkg: false
            brew_archive: false
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary_name: clashtui
            build_tool: cross
            package_linux: true
            package_pkg: false
            brew_archive: true
            deb_no_strip: true
            deb_variant: "arm64"
          - os: ubuntu-latest
            target: aarch64-unknown-linux-musl
            binary_name: clashtui
            build_tool: cross
            package_linux: false
            package_pkg: false
            brew_archive: false
          - os: ubuntu-latest
            target: armv7-unknown-linux-gnueabihf
            binary_name: clashtui
            build_tool: cross
            package_linux: true
            package_pkg: false
            brew_archive: false
            deb_no_strip: true
            deb_variant: "armv7"
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary_name: clashtui.exe
            build_tool: cargo
            package_linux: false
            package_pkg: false
            brew_archive: false
          - os: macos-latest
            target: x86_64-apple-darwin
            binary_name: clashtui
            build_tool: cargo
            package_linux: false
            package_pkg: true
            brew_archive: true
          - os: macos-latest
            target: aarch64-apple-darwin
            binary_name: clashtui
            build_tool: cargo
            package_linux: false
            package_pkg: true
            brew_archive: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Set asset names
        shell: bash
        run: |
          BIN_ASSET="clashtui-${VERSION}-${{ matrix.target }}"
          if [[ "${{ matrix.binary_name }}" == *.exe ]]; then
            BIN_ASSET="${BIN_ASSET}.exe"
          fi
          echo "BIN_ASSET=${BIN_ASSET}" >> "$GITHUB_ENV"
          ARCHIVE_ASSET="clashtui-${VERSION}-${{ matrix.target }}.tar.gz"
          echo "ARCHIVE_ASSET=${ARCHIVE_ASSET}" >> "$GITHUB_ENV"
          PKG_ASSET="clashtui-${VERSION}-${{ matrix.target }}.pkg"
          echo "PKG_ASSET=${PKG_ASSET}" >> "$GITHUB_ENV"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cross
        if: ${{ matrix.build_tool == 'cross' }}
        uses: taiki-e/install-action@v2
        with:
          tool: cross

      - name: Build project (cargo)
        if: ${{ matrix.build_tool == 'cargo' }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build project (cross)
        if: ${{ matrix.build_tool == 'cross' }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Install packaging tools
        if: ${{ matrix.package_linux }}
        run: |
          cargo install cargo-deb --locked
          cargo install cargo-generate-rpm --locked

      - name: Package .deb
        if: ${{ matrix.package_linux }}
        shell: bash
        run: |
          args=(--no-build --target "${{ matrix.target }}")
          if [[ "${{ matrix.deb_no_strip }}" == "true" ]]; then
            args+=(--no-strip)
          fi
          if [[ -n "${{ matrix.deb_variant }}" ]]; then
            args+=(--variant "${{ matrix.deb_variant }}")
          fi
          cargo deb "${args[@]}"

      - name: Package .rpm
        if: ${{ matrix.package_linux }}
        run: cargo generate-rpm --target ${{ matrix.target }}

      - name: Rename binary for release
        shell: bash
        run: |
          cp target/${{ matrix.target }}/release/${{ matrix.binary_name }} "${BIN_ASSET}"

      - name: Create brew archive
        if: ${{ matrix.brew_archive }}
        shell: bash
        run: |
          tar -C "target/${{ matrix.target }}/release" -czf "${ARCHIVE_ASSET}" "${{ matrix.binary_name }}"
          SHA256="$(shasum -a 256 "${ARCHIVE_ASSET}" | awk '{print $1}')"
          META_FILE="brew-meta-${{ matrix.target }}.txt"
          {
            echo "target=${{ matrix.target }}"
            echo "sha256=${SHA256}"
            echo "url=https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/${ARCHIVE_ASSET}"
          } > "${META_FILE}"

      - name: Upload brew metadata
        if: ${{ matrix.brew_archive }}
        uses: actions/upload-artifact@v4
        with:
          name: brew-meta-${{ matrix.target }}
          path: brew-meta-${{ matrix.target }}.txt

      - name: Upload deb artifact
        if: ${{ matrix.package_linux }}
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.target }}
          path: target/debian/*.deb
          if-no-files-found: error

      - name: Build macOS .pkg
        if: ${{ matrix.package_pkg }}
        shell: bash
        run: |
          PKGROOT="pkgroot"
          mkdir -p "${PKGROOT}/usr/local/bin"
          cp "target/${{ matrix.target }}/release/${{ matrix.binary_name }}" "${PKGROOT}/usr/local/bin/${{ matrix.binary_name }}"
          pkgbuild \
            --root "${PKGROOT}" \
            --identifier "com.clashtui.app" \
            --version "${VERSION}" \
            "${PKG_ASSET}"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.BIN_ASSET }}

      - name: Upload brew archive
        uses: softprops/action-gh-release@v2
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.brew_archive }}
        with:
          files: ${{ env.ARCHIVE_ASSET }}

      - name: Upload .deb
        uses: softprops/action-gh-release@v2
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.package_linux }}
        with:
          files: target/debian/*.deb

      - name: Upload .rpm
        uses: softprops/action-gh-release@v2
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.package_linux }}
        with:
          files: target/${{ matrix.target }}/generate-rpm/*.rpm

      - name: Upload .pkg
        uses: softprops/action-gh-release@v2
        if: ${{ startsWith(github.ref, 'refs/tags/') && matrix.package_pkg }}
        with:
          files: ${{ env.PKG_ASSET }}

  publish-apt:
    name: Publish APT repo
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deb artifacts
        uses: actions/download-artifact@v4
        with:
          path: apt-artifacts
          pattern: deb-*
          merge-multiple: true

      - name: Install apt tools
        run: sudo apt-get update && sudo apt-get install -y dpkg-dev apt-utils

      - name: Build apt repo
        shell: bash
        run: |
          set -euo pipefail
          DIST="stable"
          REPO_ROOT="apt-repo"
          POOL_DIR="${REPO_ROOT}/pool/main"
          mkdir -p "${POOL_DIR}"
          shopt -s globstar
          cp apt-artifacts/**/*.deb "${POOL_DIR}/"
          ARCHES="$(for deb in "${POOL_DIR}"/*.deb; do dpkg-deb -f "${deb}" Architecture; done | sort -u)"
          for arch in ${ARCHES}; do
            BIN_DIR="${REPO_ROOT}/dists/${DIST}/main/binary-${arch}"
            mkdir -p "${BIN_DIR}"
            (
              cd "${REPO_ROOT}"
              dpkg-scanpackages -a "${arch}" "pool/main" /dev/null > "dists/${DIST}/main/binary-${arch}/Packages"
            )
            gzip -9c "${BIN_DIR}/Packages" > "${BIN_DIR}/Packages.gz"
          done
          cat > "${REPO_ROOT}/apt-ftparchive.conf" <<EOF
          APT::FTPArchive::Release {
            Origin "ClashTUI";
            Label "ClashTUI";
            Suite "${DIST}";
            Codename "${DIST}";
            Architectures "${ARCHES}";
            Components "main";
            Description "ClashTUI APT repository";
          };
          EOF
          apt-ftparchive -c "${REPO_ROOT}/apt-ftparchive.conf" release "${REPO_ROOT}/dists/${DIST}" > "${REPO_ROOT}/dists/${DIST}/Release"

      - name: Sign apt repo (optional)
        shell: bash
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          if [[ -z "${APT_GPG_PRIVATE_KEY:-}" ]]; then
            echo "APT_GPG_PRIVATE_KEY is not set, skipping signing."
            exit 0
          fi
          PASSPHRASE_ARGS=()
          if [[ -n "${APT_GPG_PASSPHRASE:-}" ]]; then
            PASSPHRASE_ARGS=(--pinentry-mode loopback --passphrase "${APT_GPG_PASSPHRASE}")
          fi
          DIST="stable"
          REPO_ROOT="apt-repo"
          echo "${APT_GPG_PRIVATE_KEY}" | gpg --batch --import
          KEY_ID="$(gpg --list-keys --with-colons | awk -F: '/^pub/ {print $5; exit}')"
          gpg --batch --yes "${PASSPHRASE_ARGS[@]}" \
            -abs -o "${REPO_ROOT}/dists/${DIST}/Release.gpg" "${REPO_ROOT}/dists/${DIST}/Release"
          gpg --batch --yes "${PASSPHRASE_ARGS[@]}" \
            --clearsign -o "${REPO_ROOT}/dists/${DIST}/InRelease" "${REPO_ROOT}/dists/${DIST}/Release"
          gpg --batch --armor --export "${KEY_ID}" > "${REPO_ROOT}/KEY.gpg"

      - name: Publish apt repo to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: apt-repo
          destination_dir: apt

  publish-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    needs: build-and-release
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}
          fetch-depth: 0

      - name: Download brew metadata
        uses: actions/download-artifact@v4
        with:
          path: brew-meta
          pattern: brew-meta-*
          merge-multiple: true

      - name: Generate Homebrew formula
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          declare -A URL
          declare -A SHA
          shopt -s globstar
          for meta in brew-meta/**/brew-meta-*.txt; do
            target=""
            sha=""
            url=""
            while IFS='=' read -r key value; do
              case "${key}" in
                target) target="${value}" ;;
                sha256) sha="${value}" ;;
                url) url="${value}" ;;
              esac
            done < "${meta}"
            if [[ -n "${target}" ]]; then
              URL["${target}"]="${url}"
              SHA["${target}"]="${sha}"
            fi
          done

          MAC_AMD64="x86_64-apple-darwin"
          MAC_ARM64="aarch64-apple-darwin"
          LINUX_AMD64="x86_64-unknown-linux-gnu"
          LINUX_ARM64="aarch64-unknown-linux-gnu"

          mkdir -p Formula
          cat > Formula/clashtui.rb <<EOF
          class Clashtui < Formula
            desc "A TUI tool for managing Clash proxies and rules"
            homepage "${REPO_URL}"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.intel?
                url "${URL[$MAC_AMD64]}"
                sha256 "${SHA[$MAC_AMD64]}"
              end
              if Hardware::CPU.arm?
                url "${URL[$MAC_ARM64]}"
                sha256 "${SHA[$MAC_ARM64]}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "${URL[$LINUX_AMD64]}"
                sha256 "${SHA[$LINUX_AMD64]}"
              end
              if Hardware::CPU.arm?
                url "${URL[$LINUX_ARM64]}"
                sha256 "${SHA[$LINUX_ARM64]}"
              end
            end

            def install
              bin.install "clashtui"
            end

            test do
              system "#{bin}/clashtui", "version"
            end
          end
          EOF

      - name: Commit Homebrew formula
        shell: bash
        run: |
          set -euo pipefail
          git add Formula/clashtui.rb
          if git diff --cached --quiet; then
            echo "No formula changes"
            exit 0
          fi
          git -c user.name="github-actions[bot]" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" \
            commit -m "chore(homebrew): update formula for ${GITHUB_REF_NAME}"
          git push origin HEAD:${{ github.event.repository.default_branch }}
